---
fontsize: 8pt
format:
    beamer:
        include-in-header: "6_Header.tex"
bibliography: 6_Referenzen.bib
---

#  {.plain}
\center
```{r, echo = FALSE, out.width = "20%", fig.align = "center"}
knitr::include_graphics("6_Abbildungen/eva_6_otto.png")
```

\huge
Evaluation und Metaanalyse
\vspace{4mm}

\large
MSc Klinische Psychologie und Psychotherapie   

SoSe 2024

\vspace{4mm}
\normalsize
Prof. Dr. Dirk Ostwald

#  {.plain}
\vfill
\center
\huge
\textcolor{black}{(6) Mehrebenenanalyse}
\vfill

# Analyse einer Multizentrenstudie mit `nlme`
```{r, echo = F}
# Datengeneration
library(MASS)                                                   # multivariate Normalverteilung
library(Matrix)                                                 # Blockdiagonalmatrizen
set.seed(0)                                                     # Zufallszahlengeneratorzustand
k           = 4                                                 # Anzahl Zentren 
n_i         = 5                                                 # Anzahl Patient:innen pro Zentrum
n           = k*n_i                                             # Gesamtanzahl an Patient:innen
x           = matrix(rep(NaN,n), ncol = k)                      # Therapiedauerarray
x[,1]       = round(runif(n_i, min = 10, max = 20))             # Therapiedauer Hochschulambulanz 1
x[,2]       = round(runif(n_i, min = 15, max = 25))             # Therapiedauer Hochschulambulanz 2
x[,3]       = round(runif(n_i, min = 20, max = 30))             # Therapiedauer Hochschulambulanz 3
x[,4]       = round(runif(n_i, min = 25, max = 35))             # Therapiedauer Hochschulambulanz 4
Xi          = array(rep(NaN,n*2), dim = c (n_i,2,k))            # Zentrenspezifische Regressionsmatrizenarray
for(i in 1:k){                                                  # Zentreniterationen        
    Xi[,,i] = matrix(c(rep(1,n_i),x[,i]), ncol = 2)}            # Zentrumspezifische Regressionmatrix             
X_f         = rbind(Xi[,,1],Xi[,,2],Xi[,,3],Xi[,,4])            # Fixed-Effects-Designmatrix
beta_f      = matrix(c(5,1), nrow = 2)                          # Fixed-Effects-Parameter
X_r         = as.matrix(bdiag(Xi[,,1],Xi[,,2],Xi[,,3],Xi[,,4])) # Random-Effects-Designmatrix
beta_r      = matrix(c(15,0,5,0,-5,0,-15,0))                    # Random-Effects-Parameter
s_eps       = 15                                                # Varianzkomponente
eps         = mvrnorm(1,rep(0,n), s_eps*diag(n))                # Fehlervektor
y           = X_f %*% beta_f + X_r %*% beta_r + eps             # Datengeneration    
HSA         = kronecker(c(1,2,3,4), rep(1,n_i))                 # Hochschulambulanzfaktor
D           = data.frame(HSA = HSA, ATS = X_f[,2], BDI = y)     # Dataframe
write.csv(D, "./6_Daten/BDI.csv", row.names = FALSE)            # Speichern
```

\vspace{2mm}
Multizentrenstudie

\footnotesize
* Studie zum Effekt von Therapiestundenanzahl auf Reduktion der Depressionssymptomatik
* Multizentrendesign mit $m = 4$ Hochschulambulanzen mit jeweils $n_i = 5$ Patient:innen
* Pre-Post-BDI-II Differenz `dBDI` als primäres Ergebnismaß  (Positive Werte = Reduktion)
* `HSA`: Hochschulambulanz, `ATS`: Anzahl Therapiestunden, `BDI`: Pre-Post-BDI-II Differenz

\footnotesize
\setstretch{.8}
```{r}
D       = read.csv("./6_Daten/BDI.csv")
print(D, digits = 1)
``` 


# Analyse einer Multizentrenstudie mit `nlme`
\vspace{2mm}
\small
Multizentrenstudie
\vspace{-1mm}

```{r, echo = F, eval = F}
D           = read.csv("./6_Daten/BDI.csv")
library(latex2exp)
pdf(
file        = "./6_Abbildungen/eva_6_multizentrendaten.pdf",
width       = 5,
height      = 5)
par(
family      = "sans",
mfcol       = c(1,1),
pty         = "m",
bty         = "l",
lwd         = 1,
las         = 1,
mgp         = c(2,1,0),
xaxs        = "i",
yaxs        = "i",
font.main   = 1,
cex         = 1,
cex.main    = 1)
cols        = c("Gray20", "Gray40", "Gray60", "Gray80")
plot(
NaN,
NaN,
xlab        = "Anzahl Therapiestunden (ATS)",
ylab        = "Symptomreduktion (BDI)",
xlim        = c(8,37),
ylim        = c(10,45))
for (i in 1:4){
    points(
    D$ATS[D$HSA == i],
    D$BDI[D$HSA == i],
    col     = "White", 
    bg      = cols[i],
    pch     = 21)
}
legend(
"topright",
c("HSA 1", "HSA 2", "HSA 3","HSA 4"),
pch         = c(16,16,16,16),
bg          = cols,
col         = cols,
bty         = "n",
cex         = .8,
x.intersp   = 1)
dev.off() 
```

```{r, echo = FALSE, out.width="50%", fig.align = "center"}
knitr::include_graphics("6_Abbildungen/eva_6_multizentrendaten.pdf")
```

\footnotesize
Zur Analyse wollen wir das R Paket `nlme` nach @pinheiro2000 nutzen.
\vspace{2mm}

\tiny
```{r, eval = F, echo = T}
install.packages("nlme")                # Installation des R Pakets
library(nlme)                           # Invokation der R Pakets
```


# Analyse einer Multizentrenstudie mit `nlme`
\setstretch{1.2}
\small
`lm()` in R
\vspace{-2mm}

\footnotesize
* `lm(formula, data)` erlaubt das evaluieren linearer Modelle der Form
\begin{equation}
y = X\beta + \varepsilon \mbox{ mit } \varepsilon \sim N(0_n,\sigma^2 I_n):
\end{equation}
* `formula` spezifiziert die Form und die Variablen des Modells als R Formel.
* `data` spezifiziert die Daten der Variablen des Modells als R Dataframe.

\small
`lmList()` in `nlme` 
\vspace{-2mm}

\footnotesize
* `lmList(formula | grouping, data)` erlaubt das evaluieren gruppenspezifischer linearer Modelle
\begin{equation}
y_i = X_i\beta_i + \varepsilon_i \mbox{ mit } \varepsilon_i \sim N(0_{n_i},\sigma^2_i I_n) \mbox{ für } i = 1,...,m:
\end{equation}
* `formula` spezifiziert die Form und die Variablen jedes der $m$ Modelle als R Formel.
* `grouping` bildet die Datengruppierungen als R Faktor ab.
* `data` spezifiziert die Daten der Variablen des Modells als R Dataframe.

\small
`lme()` in `nlme`
\vspace{-2mm}

\footnotesize
* `lme(fixed, data, random)` erlaubt das evaluieren von Linear Mixed Models der form
\begin{equation}
y = X_f\beta_f + X_r\beta_r + \varepsilon \mbox{ mit } \beta_r \sim N(0_q,\Sigma_{\beta_r}) \mbox{ und } \varepsilon \sim N(0_n,\Sigma_{\varepsilon}) 
\end{equation}
* `fixed` spezifiert die Form der Fixed-Effects-Modellkomponenten als R Formel.
* `data` spezifiziert die Daten der Variablen des Modells als R Dataframe.
* `random` spezifiert die Form der Random-Effects-Modellkomponenten als erweiterte R Formel.

# Analyse einer Multizentrenstudie mit `nlme`
\small
Evaluation eines einfachen linearen Regressionsmodells

\footnotesize
Strukturelle Form


* Wir vernachlässigen zunächst die Gruppenstruktur (Hochschulambulanzvariation) des Datensatzes.
* Wir modellieren den $i$ten `BDI`-Wert $y_i$ als Funktion des $i$ten `ATS`-Wertes $x_i$ als
\begin{equation}
y_i = \beta_0 + \beta_1x_i + \varepsilon_i \mbox{ mit } \varepsilon_i \sim N(0,\sigma^2) \mbox{ für } i = 1,...,n
\end{equation} 

Designmatrixform

* In Matrixform betrachten wir also das Modell
\begin{equation}
y = X\beta + \varepsilon  
\Leftrightarrow
\begin{pmatrix}
y_1     \\ 
\vdots  \\ 
y_n
\end{pmatrix}
= 
\begin{pmatrix}
1       & x_1       \\ 
\vdots  & \vdots    \\ 
1       & x_n
\end{pmatrix}
\begin{pmatrix}
\beta_0 \\ \beta_1
\end{pmatrix} +
\begin{pmatrix}
\varepsilon_1       \\ 
\vdots              \\ 
\varepsilon_n       \\ 
\end{pmatrix}
 \mbox{ mit } \varepsilon \sim N(0_{20},\sigma^2I_{20})
\end{equation}

Wir fassen den Datensatz also mithilfe folgender Parameterschätzer zusammen:

\begin{center}
\begin{tabular}{ll}
 Parameterschätzer  & Interpretation                                                          \\\hline
 $\hat{\beta}_0$    & Interzeptparameterschätzer/Symptomreduktion bei 0 Therapiestunden         \\
 $\hat{\beta}_1$    & Steigungsparameterschätzer/Symptomreduktion pro 1 Therapiestunde          \\
 $\hat{\sigma}^2$   & Varianzparameterschätzer/Residuelle, durch das Modell unerklärte, Varianz \\ 
\end{tabular}
\end{center} 


# Analyse einer Multizentrenstudie mit `nlme`
\small
Evaluation eines einfachen linearen Regressionsmodells
\vspace{2mm}
\tiny
\setstretch{1}
```{r, echo = T}
D           = read.csv("./6_Daten/BDI.csv")             # Einlesen des Datensatzes
M           = lm(BDI ~ ATS, D)                          # Einfache lineare Regression
S           = summary(M)                                # Modellschätzungsresultate
X           = model.matrix(M)                           # Designmatrix
beta_hat    = as.matrix(M$coefficients)                 # Betaparameterschätzer
sigsqr_hat  = S$sigma**2                                # Varianzparameterschätzer
```
Designmatrix
\setstretch{1}
```{r}
print(X)
```



# Analyse einer Multizentrenstudie mit `nlme`
\small
Evaluation eines einfachen linearen Regressionsmodells
\vspace{2mm}
```{r, echo = F, eval = F}
library(latex2exp)
pdf(
file        = "./6_Abbildungen/eva_6_einfache_lineare_regression.pdf",
width       = 5,
height      = 5)
par(
family      = "sans",
mfcol       = c(1,1),
pty         = "m",
bty         = "l",
lwd         = 1,
las         = 1,
mgp         = c(2,1,0),
xaxs        = "i",
yaxs        = "i",
font.main   = 1,
cex         = 1,
cex.main    = 1)
cols        = c("Gray20", "Gray40", "Gray60", "Gray80", "Black")
plot(
NaN,
NaN,
xlab        = "Anzahl Therapiestunden (ATS)",
ylab        = "Symptomreduktion (BDI)",
xlim        = c(8,37),
ylim        = c(10,45))
for (i in 1:4){
    points(
    D$ATS[D$HSA == i],
    D$BDI[D$HSA == i],
    col     = "White", 
    bg      = cols[i],
    pch     = 21)}
lines(
X[,2],
X %*% beta_hat,
lty     = 1,
col     = cols[5])
legend(
"topright",
c("HSA 1", "HSA 2", "HSA 3","HSA 4", TeX("X\\hat{\\beta}")),
lty         = c(NaN,NaN,NaN,NaN,  1),
pch         = c(16 ,16 ,16 ,16 ,NaN),
bg          = cols,
col         = cols,
bty         = "n",
cex         = .8,
x.intersp   = 1)
dev.off() 
```

```{r, echo = FALSE, out.width="40%", fig.align = "center"}
knitr::include_graphics("6_Abbildungen/eva_6_einfache_lineare_regression.pdf")
```
\footnotesize
```{r}
cat("Betaparameterschätzer    : ", round(beta_hat,2),
    "\nVarianzparameterschätzer : ", round(sigsqr_hat,2))
```

\footnotesize

* Keine Berücksichtigung der Gruppenstruktur (Hochschulambulanzvariation)
* Steigungsparameterschätzer $\hat{\beta}_1$ legt Abnahme der Symptomoreduktion mit Therapiedauer nahe 
* Dateninspektion zeigt aber einen Anstieg der Symptomreduktion mit Therapiestunden für jede HSA
* Das Modell ist für den betrachteten Anwendungsfall sicherlich nicht ideal


# Analyse einer Multizentrenstudie mit `nlme`
\small
Evaluation eines einfaktoriellen Varianzanalysemodells

\footnotesize
Strukturelle Form

* Wir vernachlässigen den Effekt der Therapiedauer und betrachten lediglich den Effekt der Hochschulambulanz
* Wir modellieren den $j$ten Datenwert in der $i$ten Gruppe als
\begin{equation*}
y_{1j} = \mu_0 + \varepsilon_{1j} \mbox{ und  } y_{ij} = \mu_0 + \alpha_i + \varepsilon_{ij} \mbox{ für } i = 2,3,4 \mbox{ mit } \varepsilon_{ij} \sim N(0,\sigma^2) \mbox{ für } i = 1,,...,m, j = 1, ..., n_i
\end{equation*}

\vspace{-2mm}
Designmatrixform

* In Designmatrixform betrachten wir also das Modell
\begin{equation}
y = X\beta + \varepsilon
\Leftrightarrow
\begin{pmatrix}
y_{11} \\
\vdots \\
y_{15} \\
y_{21} \\
\vdots \\
y_{25} \\
y_{31} \\
\vdots \\
y_{35} \\
y_{41} \\
\vdots \\
y_{45} \\
\end{pmatrix} = 
\begin{pmatrix}
1       & 0         &  0        & 0         \\
\vdots  & \vdots    &  \vdots   & \vdots    \\
1       & 0         &  0        & 0         \\
1       & 1         &  0        & 0         \\
\vdots  & \vdots    &  \vdots   & \vdots    \\
1       & 1         &  0        & 0         \\
1       & 0         &  1        & 0         \\
\vdots  & \vdots    &  \vdots   & \vdots    \\
1       & 0         &  1        & 0         \\
1       & 0         &  0        & 1        \\
\vdots  & \vdots    &  \vdots   & \vdots    \\
1       & 0         &  0        & 1         \\
\end{pmatrix} 
\begin{pmatrix}
\mu_0       \\
\alpha_2    \\
\alpha_3    \\
\alpha_4 \\
\end{pmatrix} +
\begin{pmatrix}
\varepsilon_{11}    \\
\vdots              \\
\varepsilon_{15}    \\
\varepsilon_{21}    \\
\vdots              \\
\varepsilon_{25}    \\
\varepsilon_{31}    \\
\vdots              \\
\varepsilon_{35}    \\
\varepsilon_{41}    \\
\vdots              \\
\varepsilon_{45}    \\
\end{pmatrix}
 \mbox{ mit } \varepsilon \sim N(0_{20},\sigma^2I_{20})
\end{equation}

# Analyse einer Multizentrenstudie mit `nlme`
\small
Evaluation eines einfaktoriellen Varianzanalysemodells

\footnotesize

Wir fassen den Datensatz also mithilfe folgender Parameterschätzer zusammen:

\tiny 
\center
\begin{tabular}{ll}
Parameterschätzer   & Interpretation                                                                                \\\hline
$\hat{\mu}_0$       &  Erwartungswertschätzer für die Symptomreduktion in der Referenzgruppe HSA 1                  \\
$\hat{\alpha}_2$    &  Schätzer für die Erwartungswertdifferenz für die Symptomreduktion zwischen HSA 2 und HSA 1   \\
$\hat{\alpha}_3$    &  Schätzer für die Erwartungswertdifferenz für die Symptomreduktion zwischen HSA 3 und HSA 1   \\
$\hat{\alpha}_4$    &  Schätzer für die Erwartungswertdifferenz für die Symptomreduktion zwischen HSA 4 und HSA 1   \\
$\hat{\sigma}^2$    &  Varianzparameterschätzer/Residuelle, durch das Modell unerklärte, Varianz                    \\ 
\end{tabular}

\vspace{2mm}

```{r, echo = T}
D           = read.csv("./6_Daten/BDI.csv")             # Einlesen des Datensatzes
D$HSA       = as.factor(D$HSA)                          # Umwandlung numerischer Werte in R factor
M           = lm(BDI ~ HSA, D)                          # Einfache lineare Regression
S           = summary(M)                                # Modellschätzungsresultate
X           = model.matrix(M)                           # Designmatrix
beta_hat    = as.matrix(M$coefficients)                 # Betaparameterschätzer
sigsqr_hat  = S$sigma**2                                # Varianzparameterschätzer
```

# Analyse einer Multizentrenstudie mit `nlme`
\vspace{2mm}
\small
Evaluation eines einfaktoriellen Varianzanalysemodells
\vspace{1mm}
\footnotesize

Designmatrix
\setstretch{1}

```{r}
print(X)
```

```{r, echo = F, eval = F}
D           = read.csv("./6_Daten/BDI.csv")
library(latex2exp)
pdf(
file        = "./6_Abbildungen/eva_6_einfaktorielle_varianzanalyse.pdf",
width       = 5,
height      = 5)
par(
family      = "sans",
mfcol       = c(1,1),
pty         = "m",
bty         = "l",
lwd         = 1,
las         = 1,
mgp         = c(2,1,0),
xaxs        = "i",
yaxs        = "i",
font.main   = 1,
cex         = 1,
cex.main    = 1)
cols        = c("Gray20", "Gray40", "Gray60", "Gray80")
plot(
NaN,
NaN,
xlab        = "Hochschulambulanz (HSA)",
ylab        = "Symptomreduktion (BDI)",
xlim        = c(0,5),
xaxt        = "n",
ylim        = c(15,45))
for (i in 1:4){
    points(
    rep(i,5), 
    D$BDI[D$HSA == i],
    col     = "White", 
    bg      = cols[i],
    pch     = 21)
}
points(
D$HSA, 
X %*% beta_hat,
pch     = 8)
legend(
"topright",
c("HSA 1", "HSA 2", "HSA 3","HSA 4", TeX("X\\hat{\\beta}")),
pch         = c(16 ,16 ,16 ,16 ,8),
bg          = cols,
col         = cols,
bty         = "n",
cex         = .8,
x.intersp   = 1)
dev.off() 
```
# Analyse einer Multizentrenstudie mit `nlme`
\vspace{2mm}
\small
Evaluation eines einfaktoriellen Varianzanalysemodells

```{r, echo = FALSE, out.width="40%", fig.align = "center"}
knitr::include_graphics("6_Abbildungen/eva_6_einfaktorielle_varianzanalyse.pdf")
```

\setstretch{1.2}
\footnotesize
```{r}
cat("Betaparameterschätzer    : ", round(beta_hat,2),
    "\nVarianzparameterschätzer : ", round(sigsqr_hat,2))
```

* Keine Berücksichtigung der Anzahl an Therapiestunden
* Das Modell ist vor dem Hintergrund der Frage nach dem Therapiestundeneffekt sicherlich nicht ideal 
* HSA 2, HSA 3 und HSA 4 haben einer geringere Symptomereduktionserwartung als HSA 1
* Dateninspektion zeigt unterschiedliche mittlere Therapiestundenanzahlen pro HSA


# Analyse einer Multizentrenstudie mit `nlme`
\small
\vspace{2mm}
Evaluation gruppenspezifischer einfacher linearen Regressionsmodelle

\footnotesize
Strukturelle Form

* Wir betrachten jede der Gruppen (Hochschulambulanzen) einzeln.
* Wir modellieren den $j$ten `BDI`-Wert der $i$ten Gruppe $y_{i_j}$ als Funktion des $i,j$ten `ATS`-Wertes $x_{i_j}$
\begin{equation}
y_{i_j} = \beta_{i_0} + \beta_{i_1}x_{i_j} + \varepsilon_{i_j} \mbox{ mit } \varepsilon_{i_j} \sim N(0,\sigma_i^2) \mbox{ für } i = 1,...,m, j = 1,...,n_i.
\end{equation}

* In Matrixform betrachten wir also für $i = 1,...,k$ 
\begin{equation}
y_i = X_i\beta_i + \varepsilon_i  
\Leftrightarrow
\begin{pmatrix}
y_{i_1}                 \\ 
\vdots                  \\ 
y_{i_{n_i}}
\end{pmatrix}
= 
\begin{pmatrix}
1       & x_{i_1}       \\ 
\vdots  & \vdots        \\ 
1       & x_{i_{n_i}}
\end{pmatrix}
\begin{pmatrix}
\beta_{i_0} \\ \beta_{i_1}
\end{pmatrix} +
\begin{pmatrix}
\varepsilon_{i_1}       \\ 
\vdots              \\ 
\varepsilon_{i_{n_i}}       \\ 
\end{pmatrix}
 \mbox{ mit } \varepsilon_i \sim N(0_{n_i},\sigma^2I_{n_i})
\end{equation}

Wir fassen den Datensatz also mithilfe folgender Parameterschätzer für jede Gruppe $i = 1,...,m$ zusammen:

\center
\begin{tabular}{ll}
Parameterschätzer       & Interpretation                                                                        \\\hline
$\hat{\beta}_{i_0}$     & Interzeptparameterschätzer/Symptomreduktion bei 0 Therapiestunden in HSA $i$          \\
$\hat{\beta}_{i_1}$     & Steigungsparameterschätzer/Symptomreduktion pro 1 Therapiestunde  in HSA $i$          \\
$\hat{\sigma}^2_{i}$    & Varianzparameterschätzer/Residuelle, durch das Modell unerklärte, Varianz in HSA $i$  \\
\end{tabular} 

# Analyse einer Multizentrenstudie mit `nlme`
\small
\vspace{2mm}
Evaluation gruppenspezifischer einfacher linearen Regressionsmodelle
\vspace{3mm}
\tiny 
```{r, echo = T}
library(nlme)
D           = read.csv("./6_Daten/BDI.csv")                 # Einlesen des Datensatzes
M           = lmList(BDI ~ ATS | HSA, D)                    # gruppenspezifische ELRs
S           = list()                                        # Liste für Modelschätzungsresultate
X           = list()                                        # Liste für Designmatrizen
beta_hat    = list()                                        # Liste für Betaparameterschätzer
sigsqr_hat  = list()                                        # Liste für Varianzparameterschätzer
for(i in 1:length(M)){                                      # Gruppeniterationen
    S[[i]]              = summary(M[[i]])                   # Modellschätzungsresultate
    X[[i]]              = model.matrix(M[[i]])              # Designmatrix
    beta_hat[[i]]       = as.matrix(M[[i]]$coefficients)    # Betaparameterschätzer
    sigsqr_hat[[i]]     = S[[i]]$sigma**2}                  # Varianzparameterschätzer
```
\vspace{3mm}

\footnotesize
`BDI ~ ATS | HSA` ist eine erweiterte R Formel, die `BDI` und `ATS` anhand der Level des Faktors `HSA` partitioniert!


# Analyse einer Multizentrenstudie mit `nlme`
\small
\vspace{2mm}
Evaluation gruppenspezifischer einfacher linearen Regressionsmodelle

\footnotesize
Designmatrizen

\vspace{1mm}
\tiny
\setstretch{1}
```{r}
for(i in 1:length(M)){
print(X[[i]])
}
```


# Analyse einer Multizentrenstudie mit `nlme`
\small
\vspace{2mm}
Evaluation gruppenspezifischer einfacher linearen Regressionsmodelle

```{r, echo = F, eval = F}
D           = read.csv("./6_Daten/BDI.csv")
library(latex2exp)
pdf(
file        = "./6_Abbildungen/eva_6_gruppen_einfache_lineare_regressionen.pdf",
width       = 5,
height      = 5)
par(
family      = "sans",
mfcol       = c(1,1),
pty         = "m",
bty         = "l",
lwd         = 1,
las         = 1,
mgp         = c(2,1,0),
xaxs        = "i",
yaxs        = "i",
font.main   = 1,
cex         = 1,
cex.main    = 1)
cols        = c("Gray20", "Gray40", "Gray60", "Gray80")
plot(
NaN,
NaN,
xlab        = "Anzahl Therapiestunden (ATS)",
ylab        = "Symptomreduktion (BDI)",
xlim        = c(8,37),
ylim        = c(10,45))
for (i in 1:4){
    points(
    D$ATS[D$HSA == i],
    D$BDI[D$HSA == i],
    col     = "White", 
    bg      = cols[i],
    pch     = 21)
    lines(
    X[[i]][,2],
    X[[i]] %*% beta_hat[[i]],
    lty     = 1,
    col     = cols[i])
}
legend(
"topright",
c("HSA 1", "HSA 2", "HSA 3","HSA 4"),
pch         = c(16,16,16,16),
bg          = cols,
col         = cols,
bty         = "n",
cex         = .8,
x.intersp   = 1)
dev.off() 
```

```{r, echo = FALSE, out.width="40%", fig.align = "center"}
knitr::include_graphics("6_Abbildungen/eva_6_gruppen_einfache_lineare_regressionen.pdf")
```
\vspace{-2mm}
\setstretch{1.2}
\tiny 
```{r}
for(i in 1:length(M)){
cat("\nHSA", i, "Betaparameterschätzer    : ", round(beta_hat[[i]],2),
    " Varianzparameterschätzer: ",  round(sigsqr_hat[[i]],2))}
```

\footnotesize
* Es wird deutlich, dass die Symptomreduktion in jeder HSA mit steigender Therapiestundenanzahl zunimmt.
* Dies entspricht der Intuition bei HSA-spezifischer Dateninspektion.
* Es wird allerdings kein HSA-übergreifender Therapiestundenanzahleffekt bestimmt.
* Es wird auch kein Maß für die Varianz der Effekt zwischen den Hochschulambulanzen bestimmt.

# Analyse einer Multizentrenstudie mit `nlme`
\vspace{2mm}
\small
Evaluation eines Einfache-Lineare-Regression-LMMs mit zufälligem Interzeptparameter

\footnotesize
Strukturelle Form

* Wir modellieren den $j$ten Datenwert in der $i$ten Gruppe mit $j = 1,...,5$ und $i = 1,...,4$ als
\begin{equation}
y_{ij} = \beta_0 + \beta_{1}x_{ij} + \beta_{0i} + \varepsilon_{ij} \mbox{ mit } \beta_{0i} \sim N(0,\sigma_{\beta_r}^2) \mbox{ mit } \varepsilon_{ij} \sim N(0,\sigma^2)
\end{equation}

Designmatrixform

\begin{equation}
y = X_f\beta_f + X_r\beta_r + \varepsilon
\Leftrightarrow
\begin{pmatrix}
y_{11} \\
\vdots \\
y_{15} \\
y_{21} \\
\vdots \\
y_{25} \\
y_{31} \\
\vdots \\
y_{35} \\
y_{41} \\
\vdots \\
y_{45} \\
\end{pmatrix} = 
\begin{pmatrix}
1       & x_{11}    \\
\vdots  & \vdots    \\
1       & x_{15}    \\
1       & x_{21}    \\
\vdots  & \vdots    \\
1       & x_{25}    \\
1       & x_{31}    \\
\vdots  & \vdots    \\
1       & x_{35}    \\
1       & x_{41}    \\
\vdots  & \vdots    \\
1       & x_{45}    \\
\end{pmatrix}
\begin{pmatrix}
\beta_{0}  \\
\beta_{1}  \\
\end{pmatrix} +
\begin{pmatrix}
1       & 0         &  0        & 0         \\
\vdots  & \vdots    &  \vdots   & \vdots    \\
1       & 0         &  0        & 0         \\
0       & 1         &  0        & 0         \\
\vdots  & \vdots    &  \vdots   & \vdots    \\
0       & 1         &  0        & 0         \\
0       & 0         &  1        & 0         \\
\vdots  & \vdots    &  \vdots   & \vdots    \\
0       & 0         &  1        & 0         \\
0       & 0         &  0        & 1        \\
\vdots  & \vdots    &  \vdots   & \vdots    \\
0       & 0         &  0        & 1         \\
\end{pmatrix} 
\begin{pmatrix}
\beta_{01}  \\
\beta_{02}  \\
\beta_{03}   \\
\beta_{04   }\\
\end{pmatrix} +
\begin{pmatrix}
\varepsilon_{11}    \\
\vdots              \\
\varepsilon_{15}    \\
\varepsilon_{21}    \\
\vdots              \\
\varepsilon_{25}    \\
\varepsilon_{31}    \\
\vdots              \\
\varepsilon_{35}    \\
\varepsilon_{41}    \\
\vdots              \\
\varepsilon_{45}    \\
\end{pmatrix}
\end{equation}
mit
\begin{equation}
\beta_r \sim N(0_4,\sigma^2_{\beta_r}I_{4})
\mbox{ und }
\varepsilon \sim N(0_{20},\sigma^2I_{20})
\end{equation}

# Analyse einer Multizentrenstudie mit `nlme`

\vspace{2mm}
\small
Evaluation eines Einfache-Lineare-Regression-LMMs mit zufälligem Interzeptparameter

\footnotesize
Wir fassen den Datensatz als für $i = 1,...,4$ mithilfe folgender Parameterschätzer zusammen:
\center
\begin{tabular}{ll}
Parameterschätzer               & Interpretation                                                                    \\\hline
$\hat{\beta}_0$                 & FFX-Interzept-Schätzer/HSA-übergreifende Symptomreduktion bei 0 Therapiestunden   \\
$\hat{\beta}_1$                 & FFX-Steigungs-Schätzer/HSA-übergreifende Symptomreduktion pro 1 Therapiestunde    \\
$\hat{\beta}_{0i}$              & RFX-Interzept-Schätzer/HSA $i$-spezifische Symptomreduktion bei 0 Therapiestunden \\
$\hat{\sigma}^2_{\beta_r}$      & RFX-Varianz-Schätzer/HSA-übergreifende Interzeptvarianz                           \\
$\hat{\sigma}^2$                & Datenvarianz-Schätzer/Residuelle, durch das Modell unerklärte, Varianz            \\
\end{tabular}   

\vspace{3mm}
\tiny
\setstretch{1}
```{r, echo = T}
library(nlme)                                               # R Paket
D               = read.csv("./6_Daten/BDI.csv")             # Einlesen des Datensatzes
D$HSA           = as.factor(D$HSA)                          # Umwandlung numerischer Werte in R factor
M               = lme(BDI ~ ATS, D, random = ~ 1 | HSA)     # LMM vom Einfache Lineare Regressionstyp 
X_f             = model.matrix(M, D)                        # Fixed-Effects-Designmatrix
X_r             = model.matrix(~ M$groups[[1]] - 1)         # Random-Effects-Designmatrix
beta_f_hat      = M$coefficients$fixed                      # Fixed-Effects-Parameterschätzer
beta_r_hat      = M$coefficients$random$HSA                 # Random-Effects-Parameterschätzer
s_eps_hat       = M$sigma**2                                # Datenvarianzkomponente
s_beta_r_hat    = diag(getVarCov(M))                        # Random-Effects-Varianzkomponente
```

\footnotesize
`random = ~ 1 | HSA` enkodiert einen gruppenspezifischen zufälligen Interzeptparameter

# Analyse einer Multizentrenstudie mit `nlme`
\vspace{2mm}
\small
Evaluation eines Einfache-Lineare-Regression-LMMs mit zufälligem Interzeptparameter
\vspace{1mm}

\footnotesize
Fixed-Effects-Designmatrix

\setstretch{1}
\tiny
```{r}
print(X_f)
```


# Analyse einer Multizentrenstudie mit `nlme`
\vspace{2mm}
\small
Evaluation eines Einfache-Lineare-Regression-LMMs mit zufälligem Interzeptparameter

\footnotesize
Random-Effects-Designmatrix

\setstretch{.9}
\tiny
```{r}
print(X_r)
```


# Analyse einer Multizentrenstudie mit `nlme`
\vspace{1mm}
\small
Evaluation eines Einfache-Lineare-Regression-LMMs mit zufälligem Interzeptparameter
\vspace{-1mm}
```{r, echo = F, eval = F}
library(latex2exp)
D           = read.csv("./6_Daten/BDI.csv")
y_hat       = X_f %*% beta_f_hat + X_r %*% beta_r_hat
idxs        = list(1:5,6:10,11:15,16:20)
pdf(
file        = "./6_Abbildungen/eva_6_lmm_elr_random_interzept.pdf",
width       = 5,
height      = 5)
par(
family      = "sans",
mfcol       = c(1,1),
pty         = "m",
bty         = "l",
lwd         = 1,
las         = 1,
mgp         = c(2,1,0),
xaxs        = "i",
yaxs        = "i",
font.main   = 1,
cex         = 1,
cex.main    = 1)
cols        = c("Gray20", "Gray40", "Gray60", "Gray80")
plot(
NaN,
NaN,
xlab        = "Anzahl Therapiestunden (ATS)",
ylab        = "Symptomreduktion (BDI)",
xlim        = c(8,37),
ylim        = c(10,45))
for (i in 1:4){
    points(
    D$ATS[D$HSA == i],
    D$BDI[D$HSA == i],
    col     = "White", 
    bg      = cols[i],
    pch     = 21)
    lines(
    X_f[idxs[[i]],2] ,
    y_hat[idxs[[i]]] ,
    col     = cols[i],
    lty     = 1)
}
legend(
"topright",
c("HSA 1", "HSA 2", "HSA 3","HSA 4"),
pch         = c(16,16,16,16),
bg          = cols,
col         = cols,
bty         = "n",
cex         = .8,
x.intersp   = 1)
dev.off() 
```

```{r, echo = FALSE, out.width="40%", fig.align = "center"}
knitr::include_graphics("6_Abbildungen/eva_6_lmm_elr_random_interzept.pdf")
```
\vspace{-1mm}
\tiny
\setstretch{.9}
```{r}
cat("Fixed-Effects-Parameterschätzer  : ", round(beta_f_hat,2), 
    "\nResiduelle Varianzschätzer       : ", round(s_eps_hat,2),
    "\nRandom-Effects-Varianzschätzer   : ", round(s_beta_r_hat,2)) 
```
```{r}
print("Random-Effects-Parameterschätzer")
print(beta_r_hat)
```

\footnotesize
\setstretch{1.4}
* Es wird deutlich, dass die Symptomreduktion über HSAs mit steigender Therapiestundenanzahl zunimmt.
* Die Annahme, dass die Symptomreduktionsrate in jeder HSA gleich ist, mag etwas stark sein (vgl. HSA 4).

# Analyse einer Multizentrenstudie mit `nlme`
\vspace{2mm}
\small
Evaluation eines ELR-LMMs mit zufälligen Interzept- und Steigungsparametern
\footnotesize

Strukturelle Form

* Wir modellieren den $j$ten Datenwert in der $i$ten Gruppe mit $j = 1,...,5$ und $i = 1,...,4$ als
\begin{equation}
y_{ij} = \beta_0 + \beta_{1}x_{ij} + \beta_{0i} + \beta_{1i}x_{ij} + \varepsilon_{ij} \mbox{ mit } \beta_{ki} \sim N(0,\sigma_{\beta_r}^2) \mbox{ für } k = 0,1 \mbox{ und } \varepsilon_{ij} \sim N(0,\sigma^2)
\end{equation}

\footnotesize
Designmatrixform 
\begin{equation}
y = X_f\beta_f + X_r\beta_r + \varepsilon \Leftrightarrow
\end{equation}
\begin{equation}
\begin{pmatrix}
y_{11} \\
\vdots \\
y_{15} \\
y_{21} \\
\vdots \\
y_{25} \\
y_{31} \\
\vdots \\
y_{35} \\
y_{41} \\
\vdots \\
y_{45} \\
\end{pmatrix} = 
\begin{pmatrix}
1       & x_{11}    \\
\vdots  & \vdots    \\
1       & x_{15}    \\
1       & x_{21}    \\
\vdots  & \vdots    \\
1       & x_{25}    \\
1       & x_{31}    \\
\vdots  & \vdots    \\
1       & x_{35}    \\
1       & x_{41}    \\
\vdots  & \vdots    \\
1       & x_{45}    \\
\end{pmatrix}
\begin{pmatrix}
\beta_{0}  \\
\beta_{1}  \\
\end{pmatrix} +
\begin{pmatrix}
1       & x_{11}    & 0         &  0        & 0         & 0         & 0         & 0         \\
\vdots  & \vdots    & \vdots    &  \vdots   & \vdots    & \vdots    & \vdots    & \vdots    \\
1       & x_{15}    & 0         &  0        & 0         & 0         & 0         & 0         \\
0       & 0         & 1         &  x_{21}   & 0         & 0         & 0         & 0         \\
\vdots  & \vdots    & \vdots    &  \vdots   & \vdots    & \vdots    & \vdots    & \vdots    \\
0       & 0         & 1         &  x_{25}   & 0         & 0         & 0         & 0         \\
0       & 0         & 0         &  0        & 1         & x_{31}    & 0         & 0         \\
\vdots  & \vdots    & \vdots    &  \vdots   & \vdots    & \vdots    & \vdots    & \vdots    \\
0       & 0         & 0         &  0        & 1         & x_{35}    & 0         & 0         \\
0       & 0         & 0         &  0        & 0         & 0         & 1         & x_{41}    \\
\vdots  & \vdots    & \vdots    &  \vdots   & \vdots    & \vdots    & \vdots    & \vdots    \\
0       & 0         & 0         &  0        & 0         & 0         & 1         & x_{45}    \\
\end{pmatrix} 
\begin{pmatrix}
\beta_{01}  \\
\beta_{11}  \\
\beta_{02}  \\
\beta_{12}  \\
\beta_{03}  \\
\beta_{13}  \\
\beta_{04}  \\
\beta_{14}  \\
\end{pmatrix} +
\begin{pmatrix}
\varepsilon_{11}    \\
\vdots              \\
\varepsilon_{15}    \\
\varepsilon_{21}    \\
\vdots              \\
\varepsilon_{25}    \\
\varepsilon_{31}    \\
\vdots              \\
\varepsilon_{35}    \\
\varepsilon_{41}    \\
\vdots              \\
\varepsilon_{45}    \\
\end{pmatrix}
\end{equation}
mit
\begin{equation}
\beta_r \sim N(0_8,\sigma^2_{\beta_r}I_{8})
\mbox{ und }
\varepsilon \sim N(0_{20},\sigma^2I_{20})
\end{equation}

# Analyse einer Multizentrenstudie mit `nlme`
\vspace{2mm}
\small
Evaluation eines ELR-LMMs mit zufälligen Interzept- und Steigungsparametern

\footnotesize
Wir fassen den Datensatz als für $i = 1,...,4$ mithilfe folgender Parameterschätzer zusammen:

\center

\begin{tabular}{ll}
Parameterschätzer           &  Interpretation                                                                   \\\hline
$\hat{\beta}_0$             & FFX-Interzept-Schätzer/HSA-übergreifende Symptomreduktion bei 0 Therapiestunden   \\
$\hat{\beta}_1$             & FFX-Steigungs-Schätzer/HSA-übergreifende Symptomreduktion pro 1 Therapiestunde    \\
$\hat{\beta}_{0i}$          & RFX-Interzept-Schätzer/HSA $i$-spezifische Symptomreduktion bei 0 Therapiestunden \\
$\hat{\beta}_{1i}$          & RFX-Steigungs-Schätzer/HSA $i$-spezifische Symptomreduktion pro 1 Therapiestunde  \\
$\hat{\sigma}^2_{\beta_r}$  & RFX-Varianz-Schätzer/HSA-übergreifende Interzept- und Steigungsvarianz            \\ 
$\hat{\sigma}^2$            & Datenvarianz-Schätzer/Residuelle, durch das Modell unerklärte, Varianz            \\
\end{tabular}   
\vspace{1mm}
\tiny

```{r, echo = T}
library(nlme)                                                             # R Paket 
ctrl            = lmeControl(opt = "optim", maxIter = 100)                # Anzahl an ReML Iterationen
D               = read.csv("./6_Daten/BDI.csv")                           # Einlesen des Datensatzes
D$HSA           = as.factor(D$HSA)                                        # Umwandlung numerischer Werte in R factor
M               = lme(BDI ~ ATS, D, random = ~ ATS | HSA, control = ctrl) # LMM vom Einfache Lineare Regressionstyp 
X_f             = model.matrix(M,D)                                       # Fixed-Effects-Designmatrix
beta_f_hat      = M$coefficients$fixed                                    # Fixed-Effects-Parameterschätzer
beta_r_hat      = M$coefficients$random$HSA                               # Random-Effects-Parameterschätzer
sigsqr_eps_hat  = M$sigma**2                                              # Datenvarianzkomponente
```

# Analyse einer Multizentrenstudie mit `nlme`
```{r, echo = F, eval = F}
library(latex2exp)
D           = read.csv("./6_Daten/BDI.csv")
idxs        = list(1:5,6:10,11:15,16:20)
pdf(
file        = "./6_Abbildungen/eva_6_lmm_elr_random_interzept_steigung.pdf",
width       = 5,
height      = 5)
par(
family      = "sans",
mfcol       = c(1,1),
pty         = "m",
bty         = "l",
lwd         = 1,
las         = 1,
mgp         = c(2,1,0),
xaxs        = "i",
yaxs        = "i",
font.main   = 1,
cex         = 1,
cex.main    = 1)
cols        = c("Gray20", "Gray40", "Gray60", "Gray80")
plot(
NaN,
NaN,
xlab        = "Anzahl Therapiestunden (ATS)",
ylab        = "Symptomreduktion (BDI)",
xlim        = c(8,37),
ylim        = c(10,45))
for (i in 1:4){
    points(
    D$ATS[D$HSA == i],
    D$BDI[D$HSA == i],
    col     = "White", 
    bg      = cols[i],
    pch     = 21)
    lines(
    X_f[idxs[[i]],2] ,
    X_f[idxs[[i]], ] %*% beta_f_hat + X_f[idxs[[i]], ] %*%  beta_r_hat[i,],
    col     = cols[i],
    lty     = 1)
}
legend(
"topright",
c("HSA 1", "HSA 2", "HSA 3","HSA 4"),
pch         = c(16,16,16,16),
bg          = cols,
col         = cols,
bty         = "n",
cex         = .8,
x.intersp   = 1)
dev.off() 
```

\vspace{1mm}
\small
Evaluation eines ELR-LMMs mit zufälligen Interzept- und Steigungsparametern
\vspace{-2mm}
```{r, echo = FALSE, out.width="40%", fig.align = "center"}
knitr::include_graphics("6_Abbildungen/eva_6_lmm_elr_random_interzept_steigung.pdf")
```
\vspace{-2mm}
\tiny
\setstretch{1}
```{r}
cat("Fixed-Effects-Parameterschätzer  : ", round(beta_f_hat,2), 
    "\nResiduelle Varianzschätzer       : ", round(s_eps_hat,2),
    "\nRandom-Effects-Varianzschätzer   : ", round(s_beta_r_hat,2)) 
```
```{r}
print("Random-Effects-Parameterschätzer")
print(beta_r_hat)
```
\vspace{-2mm}
\footnotesize
\setstretch{1.4}
* Es wird deutlich, dass die Symptomreduktion über HSAs mit steigender Therapiestundenanzahl zunimmt.
* Die Symptomreduktionsrate varriieren nicht unabhängig über HSAs, sondern durch andere HSAs informiert. 

#  {.plain}
\vfill
\center
\huge
\textcolor{black}{Appendix}
\vfill



# Appendix
\small
R Formeln

\footnotesize
Modelle der Form $y = X\beta + \varepsilon$ mit $\varepsilon \sim N(0_n,\sigma^2 I_n)$ werden in R symbolisch durch `formulas` dargestellt

\vspace{2mm}
```{r, eval = F, error = F, echo = T}
Daten ~ Term 1 + Term 2 + ... + Term k
```

* Der `~` Operator trennt die linke Seite und rechte Seite einer `formula` 
* `Daten` wird zur Identifikation der abhängigen Variable $y$ genutzt 
* `Term 1 + Term 2 + ... + Term k` dient der Spezifikation der Spalten der Designmatrix $X$ 
* Die `formulas` Syntax geht zurück auf @wilkinson1973 und @chambers1992 

Terme können numerische Prädiktoren oder kategoriale Faktoren (R `factors`) sein

Die `formula` Syntax ist symbolisch, zur Laufzeit müssen die Prädiktoren und Faktoren nicht spezifiziert sein

Essentielle Operatoren in `formulas` sind `+` und `:`

* `+` fügt der Designmatrix Prädiktoren hinzu, `:` dient der Spezifikation von Interaktionen

Nichtessentielle Operatoren in `formulas` sind `*`, `/`, `%in%`, `-` und `^`

* Für zwei Faktoren `f1` und `f2` gilt beispielsweise `f1*f2 = f1 + f2 + f1:f2`


# Appendix
\small
R Formeln


\footnotesize 
Beispiele mit `x1`, `x2` als numerische Vektoren und `f1`, `f2` als R Faktoren
\vspace{2mm}

\setstretch{1.5}
\tiny
```{r, echo = T, eval = F}
formula(y ~ x1)         # Spezifikation einer einfachen linearen Regresssion mithilfe der formula() Funktion              
y ~ x1                  # Aufruf der formula() Funktion ist aber nicht nötig, R erkennt formulas auch so 
y ~ 1 + x1              # Explizite Interzeptdefinition bei einfacher linearer Regression, nicht nötig
y ~ 0 + x1              # Verzicht auf Interzeptdefinition bei einfacher lineare Regression
y ~ 1 + x1 + x2         # Multiple Regression mit zwei Regressoren und expliziter Interzeptdefinition
y ~ f1                  # Einfaktorielles ANOVA Design 
y ~ f1 + f2             # Additives zweifaktorielles ANOVA Design 
y ~ f1 + f2 + f1:f2     # Zweifaktorielles ANOVA Design mit Interaktion
y ~ f1 + x1             # Additives einfaktorielles ANCOVA Design mit einer Kovariate 
y ~ f1 + x1 + f1:x1     # Einfaktorielles ANCOVA Design mit einer Kovariate und Interaktion
```

\footnotesize
Wir betrachten im Folgenden die durch diese `formulas` erzeugten Designmatrizen $X \in \mathbb{R}^{n \times p}$.

# Appendix
\small
R Formeln

\footnotesize
Einfache Lineare Regression

\vspace{2mm}
\tiny 
\setstretch{1.1}
```{r, echo = T}
n   = 12                                                    # Anzahl Datenpunkte
x1  = 1:n                                                   # Regressor
y   = rnorm(n)                                              # Beispieldaten
D   = data.frame(y = y, x1 = x1)                            # Dataframe
M   = lm(y ~ x1, D)                                         # Modellevaluation
X   = model.matrix(M)                                       # Designmatrix    
```
```{r}
print(X)
```


# Appendix
\small
R Formeln

\footnotesize
Einfache Lineare Regression mit expliziter Interzeptdefinition

\vspace{2mm}
\tiny 
\setstretch{1.1}
```{r, echo = T}
n   = 12                                                    # Anzahl Datenpunkte
x1  = 1:n                                                   # Regressor
y   = rnorm(n)                                              # Beispieldaten
D   = data.frame(y = y, x1 = x1)                            # Dataframe
M   = lm(y ~ 1 + x1, D)                                     # Modellevaluation
X   = model.matrix(M)                                       # Designmatrix    
```
```{r}
print(X)
```


# Appendix
\small
R Formeln

\footnotesize
Einfache Lineare Regression mit Verzicht auf Interzeptdefinition

\vspace{2mm}
\tiny 
\setstretch{1.1}
```{r, echo = T}
n   = 12                                                    # Anzahl Datenpunkte
x1  = 1:n                                                   # Regressor
y   = rnorm(n)                                              # Beispieldaten
D   = data.frame(y = y, x1 = x1)                            # Dataframe
M   = lm(y ~ 0 + x1, D)                                     # Modellevaluation
X   = model.matrix(M)                                       # Designmatrix    
```
```{r}
print(X)
```

# Appendix
\small
R Formeln

\footnotesize
Multiple Regression mit zwei Regressoren und expliziter Interzeptdefinition

\vspace{2mm}
\tiny 
\setstretch{1.1}
```{r, echo = T}
n   = 12                                                    # Anzahl Datenpunkte
x1  = 1:n                                                   # Regressor 1
x2  = (1:n)+5                                               # Regressor 2
y   = rnorm(n)                                              # Beispieldaten
D   = data.frame(y = y, x1 = x1, x2 = x2)                   # Dataframe
M   = lm(y ~ 1 + x1 + x2, D)                                # Modellevaluation
X   = model.matrix(M)                                       # Designmatrix    
```
```{r}
print(X)
```

# Appendix
\small
R Formeln

\footnotesize
Einfaktorielles ANOVA Design mit drei Faktorleveln

\vspace{2mm}
\tiny 
\setstretch{1.1}
```{r, echo = T}
n   = 12                                                    # Anzahl Datenpunkte
f1  = as.factor(c(1,1,1,1,2,2,2,2,3,3,3,3))                 # Faktorlevel der Datenpunkte
y   = rnorm(n)                                              # Beispieldaten
D   = data.frame(y = y, f1 = f1)                            # Dataframe
M   = lm(y ~ f1, D)                                         # Modellevaluation
X   = model.matrix(M)                                       # Designmatrix    
```
```{r}
print(X)
```

# Appendix
\vspace{2mm}
\small
R Formeln

\footnotesize
Zweifaktorielles additives ANOVA Design mit jeweils zwei Faktorleveln

\vspace{2mm}
\tiny 
\setstretch{1.1}
```{r, echo = T}
n   = 12                                                    # Anzahl Datenpunkte
f1  = as.factor(c(1,1,1,1,1,1,2,2,2,2,2,2))                 # Faktor-1-Level der Datenpunkte
f2  = as.factor(c(1,1,1,2,2,2,1,1,1,2,2,2))                 # Faktor-2-Level der Datenpunkte
y   = rnorm(n)                                              # Beispieldaten
D   = data.frame(y = y, f1 = f1, f2 = f2)                   # Dataframe
M   = lm(y ~ f1 + f2, D)                                    # Modellevaluation
X   = model.matrix(M)                                       # Designmatrix    
```
```{r}
print(X)
```


# Appendix
\vspace{2mm}
\small
R Formeln

\footnotesize
Zweifaktorielles additives ANOVA Design mit Interaktion

\vspace{2mm}
\tiny 
\setstretch{1.1}
```{r, echo = T}
n   = 12                                                    # Anzahl Datenpunkte
f1  = as.factor(c(1,1,1,1,1,1,2,2,2,2,2,2))                 # Faktor-1-Level der Datenpunkte
f2  = as.factor(c(1,1,1,2,2,2,1,1,1,2,2,2))                 # Faktor-2-Level der Datenpunkte
y   = rnorm(n)                                              # Beispieldaten
D   = data.frame(y = y, f1 = f1, f2 = f2)                   # Dataframe
M   = lm(y ~ f1 + f2 + f1:f2, D)                            # Modellevaluation
X   = model.matrix(M)                                       # Designmatrix    
```
```{r}
print(X)
```

# Appendix
\vspace{2mm}
\small
R Formeln

\footnotesize
Additives einfaktorielles ANCOVA Design mit einer Kovariate 

\vspace{2mm}
\tiny 
\setstretch{1.1}
```{r, echo = T}
n   = 12                                                    # Anzahl Datenpunkte
f1  = as.factor(c(1,1,1,1,1,1,2,2,2,2,2,2))                 # Faktorlevel der Datenpunkte
x1  = 1:n                                                   # Kovariatenwerte der Datenpunkte
y   = rnorm(n)                                              # Beispieldaten
D   = data.frame(y = y, f1 = f1, x1 = x1)                   # Dataframe
M   = lm(y ~ f1 + x1, D)                                    # Modellevaluation
X   = model.matrix(M)                                       # Designmatrix    
```
```{r}
print(X)
```


# Appendix
\vspace{2mm}
\small
R Formeln

\footnotesize
Einfaktorielles ANCOVA Design mit einer Kovariate und Interaktion

\vspace{2mm}
\tiny 
\setstretch{1.1}
```{r, echo = T}
n   = 12                                                    # Anzahl Datenpunkte
f1  = as.factor(c(1,1,1,1,1,1,2,2,2,2,2,2))                 # Faktorlevel der Datenpunkte
x1  = 1:n                                                   # Kovariatenwerte der Datenpunkte
y   = rnorm(n)                                              # Beispieldaten
D   = data.frame(y = y, f1 = f1, x1 = x1)                   # Dataframe
M   = lm(y ~ f1 + x1 + f1:x1, D)                            # Modellevaluation
X   = model.matrix(M)                                       # Designmatrix    
```
```{r}
print(X)
```

# Referenzen {.allowframebreaks}
\footnotesize  